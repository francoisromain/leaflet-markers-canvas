!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("leaflet")):"function"==typeof define&&define.amd?define(["leaflet"],t):t((e||self).L)}(this,function(o){"use strict";(o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o).MarkersCanvas=o.Layer.extend({initialize:function(e){o.Util.setOptions(this,e),this._markers={},this._icons={}},onAdd:function(e){this._map=e,this._initCanvas(),this.getPane().appendChild(this._canvas),e.on("moveend",this._reset,this),e.on("resize",this._reset,this),e.on("click",this._fire,this),e.on("mousemove",this._fire,this),e._zoomAnimated&&e.on("zoomanim",this._animateZoom,this)},onRemove:function(e){this.getPane().removeChild(this._canvas),e.off("click",this._fire,this),e.off("mousemove",this._fire,this),e.off("moveend",this._reset,this),e.off("resize",this._reset,this),e._zoomAnimated&&e.off("zoomanim",this._animateZoom,this)},getBounds:function(){var e,t=new o.LatLngBounds;for(e in this._markers)t.extend(this._markers[e].getLatLng());return t},addMarker:function(e,t){void 0===t&&(t=!0);var i="markerPane"!==e.options.pane,s=!e.options.icon;i||s?console.error(i?"This is not a marker":"This marker has no icon",e):(e._map=this._map,this._markers[o.Util.stamp(e)]=e,t&&this._isMarkerVisible(e)&&this._drawMarker(e))},removeMarker:function(e,t){void 0===t&&(t=!0),delete this._markers[o.Util.stamp(e)],t&&this._isMarkerVisible(e)&&this.redraw()},_initCanvas:function(){var e=this._map.getSize(),t=e.x,e=e.y,i=this._map.options.zoomAnimation&&o.Browser.any3d;this._canvas=o.DomUtil.create("canvas","leaflet-markers-canvas-layer leaflet-layer"),this._canvas.width=t,this._canvas.height=e,this._context=this._canvas.getContext("2d"),o.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(i?"animated":"hide"))},_drawMarker:function(e){var t,a=this,n=e.options.icon.options.iconUrl,i=e.getLatLng(),i=this._map.latLngToContainerPoint(i),s=i.x,i=i.y;e.image?this._drawImage(e,{x:s,y:i}):this._icons[n]?(e.image=this._icons[n].image,this._icons[n].isLoaded?this._drawImage(e,{x:s,y:i}):this._icons[n].elements.push({marker:e,x:s,y:i})):((t=new Image).src=n,e.image=t,this._icons[n]={image:t,isLoaded:!1,elements:[{marker:e,x:s,y:i}]},t.onload=function(){a._icons[n].isLoaded=!0;for(var e=a._icons[n].elements,t=0;t<e.length;t++){var i=e[t],s=i.marker,o=i.x,i=i.y;a._drawImage(s,{x:o,y:i})}})},_drawImage:function(e,t){var i=t.x,t=t.y,s=e.options.icon.options,o=s.rotationAngle,a=s.iconAnchor,s=s.iconSize,o=o||0;this._context.save(),this._context.translate(i,t),this._context.rotate(o*Math.PI/180),this._context.drawImage(e.image,-a[0],-a[1],s[0],s[1]),this._context.restore()},_getMarkerPxBounds:function(e){var t=e.getLatLng(),t=this._map.latLngToContainerPoint(t),i=t.x,t=t.y,e=e.options.icon.options,s=e.iconSize,e=e.iconAnchor;return o.bounds([i-e[0],t-e[1]],[i+s[0]-e[0],t+s[1]-e[1]])},_getMarkerLatLngBounds:function(e){var e=this._getMarkerPxBounds(e),t=e.min,e=e.max;return o.latLngBounds(this._map.containerPointToLatLng(t),this._map.containerPointToLatLng(e))},_isMarkerVisible:function(e){return!!this._map&&this._map.getBounds().overlaps(this._getMarkerLatLngBounds(e))},redraw:function(){if(this._map)for(var e in this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._markers){e=this._markers[e];this._isMarkerVisible(e)&&this._drawMarker(e)}},_reset:function(){var e=this._map.containerPointToLayerPoint([0,0]),e=(o.DomUtil.setPosition(this._canvas,e),this._map.getSize()),t=e.x,e=e.y;this._canvas.width=t,this._canvas.height=e,this.redraw()},_fire:function(e){if(this._markers){var t,i;for(i in this._markers){var s=this._markers[i];if(this._getMarkerPxBounds(s).contains(e.containerPoint)){t=s;break}}t?(this._map._container.style.cursor="pointer","click"===e.type&&t.listens("click")&&t.fire("click"),"mousemove"===e.type&&(this._mouseOverMarker&&this._mouseOverMarker!==t&&this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),this._mouseOverMarker&&this._mouseOverMarker===t||(this._mouseOverMarker=t).listens("mouseover")&&t.fire("mouseover"))):(this._map._container.style.cursor="","mousemove"===e.type&&this._mouseOverMarker&&(this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),delete this._mouseOverMarker))}},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),e=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),e.zoom,e.center).min;o.DomUtil.setTransform(this._canvas,e,t)}})});
